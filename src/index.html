<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NEW H.E.R.O.</title>
    
    <!-- Favicon personalizado -->
    <link rel="icon" type="image/x-icon" href="/src/assets/icons/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/src/assets/icons/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/src/assets/icons/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/src/assets/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/src/assets/icons/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/src/assets/icons/android-chrome-512x512.png">
    <meta name="theme-color" content="#1f2937">
    <!-- Manifest para PWA con orientaci√≥n landscape -->
    <link rel="manifest" href="/manifest.json">
    <!-- Meta tag para Netlify Identity URL (respaldo) -->
    <meta name="netlify-identity-url" content="https://newhero.netlify.app/.netlify/identity">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <!-- NES.css para estilos retro -->
    <link href="https://unpkg.com/nes.css@latest/css/nes.min.css" rel="stylesheet" />
    <!-- MIDI.js para reproducir archivos MIDI -->
    <script src="https://cdn.jsdelivr.net/npm/midi.js@0.3.0/midi.js"></script>
        <!-- Netlify Identity Widget -->
        <script>
            // Configurar URL fija ANTES de cargar el widget para evitar que pida URL al user
            window.IDENTITY_URL = 'https://newhero.netlify.app/.netlify/identity';
            // Tambi√©n guardar en localStorage como respaldo
            localStorage.setItem('netlify-identity-url', 'https://newhero.netlify.app/.netlify/identity');
        </script>
        <script src="https://identity.netlify.com/v1/netlify-identity-widget.js" onload="initializeNetlifyIdentity()"></script>
        <script>
            function initializeNetlifyIdentity() {
                var ni = window.netlifyIdentity;
                if (!ni) {
                    // Si no est√° disponible a√∫n, intentar de nuevo despu√©s de un timeout
                    setTimeout(initializeNetlifyIdentity, 100);
                    return;
                }
                
                // Prioridad: 1) Variable global, 2) Meta tag, 3) localStorage, 4) Detecci√≥n autom√°tica
                var configured = window.IDENTITY_URL || 
                                 document.querySelector('meta[name="netlify-identity-url"]')?.getAttribute('content') ||
                                 localStorage.getItem('netlify-identity-url') ||
                                 null;
                
                var isNetlifyHost = /\.netlify\.(app|live)$/i.test(window.location.host);
                var apiUrl = configured || 
                            (isNetlifyHost ? (window.location.origin + '/.netlify/identity') : null);
                
                // SIEMPRE usar la URL fija si est√° configurada, incluso en Android/Capacitor
                if (configured) {
                    apiUrl = configured;
                }
                
                if (!apiUrl) {
                    console.warn('Netlify Identity: No se pudo determinar la URL de Identity');
                    return;
                }
                
                try { 
                    // Inicializar con la URL fija y configurar para que no pida URL al user
                    ni.init({ 
                        APIUrl: apiUrl,
                        locale: 'es' // Configurar idioma espa√±ol si est√° disponible
                    }); 
                    console.log('Netlify Identity inicializado con URL:', apiUrl);
                    
                    // Observador para cerrar cualquier modal de configuraci√≥n que aparezca
                    var observer = new MutationObserver(function(mutations) {
                        mutations.forEach(function(mutation) {
                            if (mutation.addedNodes) {
                                mutation.addedNodes.forEach(function(node) {
                                    if (node.nodeType === 1) { // Element node
                                        var modal = node.classList && node.classList.contains('netlify-identity-modal') ? node : node.querySelector('.netlify-identity-modal');
                                        if (modal) {
                                            // Verificar si contiene un prompt de URL
                                            var text = modal.textContent || '';
                                            if (text.includes('URL') || text.includes('url') || text.includes('endpoint')) {
                                                modal.style.display = 'none';
                                                console.log('Modal de URL de Netlify Identity cerrado autom√°ticamente');
                                            }
                                        }
                                    }
                                });
                            }
                        });
                    });
                    
                    // Observar el body para detectar modales que se agreguen
                    observer.observe(document.body, {
                        childList: true,
                        subtree: true
                    });
                    
                    // Tambi√©n intentar cerrar inmediatamente si ya existe
                    setTimeout(function() {
                        try {
                            var modals = document.querySelectorAll('[class*="modal"], [class*="prompt"], [id*="modal"]');
                            modals.forEach(function(modal) {
                                var text = modal.textContent || '';
                                if (text.includes('URL') || text.includes('url') || text.includes('endpoint') || text.includes('Netlify')) {
                                    modal.style.display = 'none';
                                }
                            });
                        } catch(e) {
                            console.log('Verificaci√≥n de modal completada');
                        }
                    }, 500);
                } catch (e) {
                    console.error('Error inicializando Netlify Identity:', e);
                }
            }
        </script>
        <!-- Bloquear orientaci√≥n a landscape -->
        <script>
            // Bloquear orientaci√≥n v√≠a JavaScript (si el navegador lo permite)
            if (screen.orientation && screen.orientation.lock) {
                screen.orientation.lock("landscape").catch(err => console.log(err));
            }
        </script>
</head>
<body class="bg-gray-900 flex justify-center items-center h-screen overflow-hidden">

    <div id="main-container">
        <!-- Barra de UI con acciones r√°pidas (m√≥vil) - Ahora con hamburguesa -->
        <div id="right-ui" class="text-sm flex items-center justify-end gap-4" style="display: none;">
            <button id="hamburger-btn-mobile" class="hamburger-btn-mobile" aria-label="Men√∫">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>

            <!-- Contenedor Canvas con barras UI superpuestas -->
            <div class="canvas-wrapper">
                <!-- Barra Superior (superpuesta) -->
                <div id="game-ui" class="text-base" style="display: none;">
                    <div class="flex items-center gap-2">
                        <img id="hero-logo" alt="Hero" style="display: none; image-rendering: pixelated;">
                        <span class="text-lg font-bold">LEVEL: <span id="level-count">1</span></span>
                    </div>
                
                <!-- Barra de cr√©ditos (debajo de la barra superior) -->

                    <span class="text-lg font-bold">SCORE: <span id="score-count">0</span></span>
                    
                    <button id="hamburger-btn" class="hamburger-btn" aria-label="Men√∫">
                    </button>
                </div>

                <!-- Men√∫ Hamburguesa Desplegable (ya no se usa, el hamburger abre pause-menu-modal) -->
                <div id="hamburger-menu" class="hamburger-menu hidden">
                    <button id="hamburger-pause-resume-btn" class="nes-btn is-success menu-item w-full">Pausar</button>
                    <button id="hamburger-restart-game-btn" class="nes-btn is-warning menu-item w-full">Reiniciar</button>
                    <button id="hamburger-back-to-menu-btn-game" class="nes-btn is-error menu-item w-full">Men√∫ Inicial</button>
                    <button id="hamburger-resume-editor-btn-menu" class="nes-btn is-primary menu-item w-full hidden">Volver a TOOLS</button>
                    <button id="hamburger-settings-btn" class="nes-btn is-primary menu-item w-full">Configuraci√≥n</button>
                    <button id="hamburger-credits-btn" class="nes-btn menu-item w-full">Cr√©ditos</button>
                </div>
                        <!-- Bot√≥n Toggle del Panel de Usuario (siempre visible cuando el editor est√° activo) -->
        <button id="user-panel-toggle" aria-label="Toggle User Panel" class="hidden fixed left-0 text-white cursor-pointer flex items-center justify-start gap-2" style="top:12px; padding: 0 12px; min-width: 100px; height: 60px; font-size: 1rem; border-right: none; border-radius: 0 8px 8px 0; z-index: 20; font-family: 'Press Start 2P', monospace; background: rgba(0, 0, 0, 0.7); transition: all 0.3s ease;">
            <span class="toggle-icon" style="font-size: 1.2rem;">&gt;</span>
            <span class="toggle-title" style="font-size: 0.7rem; white-space: nowrap; display: none;">USUARIO</span>
        </button>
                <!-- Canvas del Juego / Editor -->
                <canvas id="gameCanvas" width="1440" height="1000"></canvas>
                        <!-- Bot√≥n Toggle del Editor (siempre visible cuando el editor est√° activo) -->
        <button id="editor-toggle" aria-label="Toggle Editor" class="hidden fixed right-0 text-white cursor-pointer flex items-center justify-end gap-2" style="top: 12px; padding: 0 12px; min-width: 100px; height: 60px; font-size: 1rem; border-left: none; border-radius: 8px 0 0 8px; z-index: 20; font-family: 'Press Start 2P', monospace; background: rgba(0, 0, 0, 0.7); transition: all 0.3s ease;">
            <span class="toggle-title" style="font-size: 0.7rem; white-space: nowrap; display: none;">TOOLS</span>
            <span class="toggle-icon" style="font-size: 1.2rem;">&lt;</span>
        </button>
        

                
                <!-- Contador de FPS (para debugging de rendimiento) -->
                <div id="fps-counter" style="position: fixed; top: 70px; right: 10px; background: rgba(0, 0, 0, 0.7); color: #00ff00; padding: 8px 12px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 14px; font-weight: bold; z-index: 1000; pointer-events: none; display: none;">
                    <div>FPS: <span id="fps-value">--</span></div>
                    <div style="font-size: 11px; color: #ffff00;">Target: <span id="fps-target">--</span></div>
                    <div style="font-size: 11px; color: #00ffff;">Res: <span id="fps-resolution">--</span></div>
                </div>
                
                <!-- Barra Inferior (superpuesta) -->
                <div id="bottom-ui" class="text-base" style="display: none;">
                    <div class="flex items-center gap-3">
                        <span class="text-lg font-bold hidden sm:inline">LIVES:</span>
                        <div id="lives-count" class="flex gap-1"></div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-lg font-bold hidden sm:inline">POWER:</span>
                        <div class="w-96 h-8 bg-gray-700 border-2 border-white energy-bar-container"><div id="energy-bar" class="h-full bg-yellow-400 transition-all duration-300 ease-in-out"></div></div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-lg font-bold hidden sm:inline">TNT:</span>
                        <div id="bombs-count" class="flex gap-1"></div>
                    </div>
                </div>
            </div>



        <!-- Panel de user para Mobile (izquierda del canvas) -->
        <div id="user-panel" class="user-panel flex-col gap-2 w-64 hidden bg-gray-800">
            <h2 id="user-panel-title" class="text-center text-lg mb-2 flex items-center justify-center gap-2 cursor-pointer" style="font-family: 'Press Start 2P', monospace;">
                <canvas id="user-panel-avatar" width="40" height="40" class="avatar-canvas cursor-pointer"></canvas>
                <span id="user-panel-nickname" class="cursor-pointer">user</span>
                <span class="toggle-icon-title" style="font-size: 1.2rem; display: none;"></span>
            </h2>
            
                <!-- √Årea de user (duplicada del editor para mobile) -->
                <div id="user-area-mobile" class="mb-4 p-2 border-2 border-gray-600 bg-gray-700" style="display: none;">
                    <button id="user-profile-btn-mobile" class="nes-btn is-primary w-full text-xs mb-2">üë§ Mi √Årea</button>
                    <button id="logout-btn-mobile" class="nes-btn is-error w-full text-xs">Cerrar sesi√≥n</button>
                </div>
            
            <!-- Bot√≥n Jugar Nivel -->
            <button id="play-test-btn-mobile" class="nes-btn is-success w-full mb-4 text-xs">Jugar Nivel</button>
            


            <!-- Secci√≥n Niveles (completa) -->
            <div class="mt-4 border-t-2 border-gray-500 pt-4">
                <div id="campaigns-section-label" class="w-full text-sm mb-2"> Campa√±as:</div>
                <button id="campaign-title-btn" class="nes-btn is-primary w-full text-sm mb-3 campaign-title" style="font-family: 'Press Start 2P', monospace;">NIVELES</button>
                <div id="levels-section-mobile-content" class="mt-2">
                    <select id="level-selector-mobile" class="w-full bg-gray-700 border-2 border-[#666] p-1 text-sm mb-2"></select>
                    <button id="add-level-btn-mobile" class="nes-btn is-primary w-full text-xs">Nuevo Nivel</button>
                    <button id="generate-level-btn-mobile" class="nes-btn is-success w-full text-xs">Generar Nivel</button>
                    <button id="save-all-btn-mobile" class="nes-btn is-error w-full mt-2 text-xs">Guardar Nivel</button>
                    <button id="share-level-btn-mobile" class="nes-btn is-primary w-full mt-2 text-xs">Compartir Nivel</button>
                </div>
            </div>
            
            <!-- Bot√≥n Volver al Men√∫ -->
            <button id="back-to-menu-btn-mobile" class="nes-btn w-full mt-4 text-xs">Men√∫ Inicial</button>
        </div>

        <!-- Panel del Editor (drawer derecho) -->
        <div id="editor-panel" class="editor-panel flex-col gap-2 w-72 hidden bg-gray-800">
                <h2 id="editor-panel-title" class="text-center text-lg mb-2 cursor-pointer" style="font-family: 'Press Start 2P', monospace;">
                    <span class="toggle-icon-title" style="font-size: 1.2rem; display: none;">&gt;</span>
                    <span>TOOLS</span>
                </h2>
                
                <!-- √Årea de user (oculta en mobile, visible en desktop) -->
                <div id="user-area" class="user-area-desktop mb-4 p-2 border-2 border-gray-600 bg-gray-700" style="display: none;">
                    <button id="user-profile-btn" class="nes-btn is-primary w-full text-xs mb-2">Mi √Årea</button>
                    <p id="user-greeting" class="text-xs mb-2"><span id="username-display">user</span></p>
                    <button id="logout-btn" class="nes-btn is-error w-full text-xs">Cerrar sesi√≥n</button>
                </div>
                
                <!-- Bot√≥n Jugar Nivel (oculto en mobile) -->
                <button id="play-test-btn" class="play-test-desktop nes-btn is-success w-full mb-4 text-xs">Probar Nivel</button>
                
                <div id="tile-palette" class="flex flex-col gap-4">
                    <!-- Tiles se agregar√°n din√°micamente aqu√≠ -->
                </div>

                <!-- Secci√≥n Edici√≥n (colapsable) -->
                <div class="mt-4 border-t-2 border-gray-500 pt-4">
                    <button id="edit-section-toggle" type="button" class="w-full text-left flex items-center justify-between px-2 py-1 border-2 border-[#666] bg-gray-700">
                        <span>Edici√≥n</span>
                        <span id="edit-section-arrow">‚ñº</span>
                    </button>
                    <div id="edit-section-content" class="mt-2">
                        <div class="grid grid-cols-2 gap-2">
                            <button id="undo-btn" class="nes-btn w-full text-xs">Deshacer</button>
                            <button id="redo-btn" class="nes-btn w-full text-xs">Rehacer</button>
                        </div>
                        <div class="mt-2">
                            <button id="duplicate-row-btn" class="nes-btn is-primary w-full text-xs">Duplicar Fila</button>
                            <button id="delete-row-btn" class="nes-btn is-error w-full text-xs mt-1">Borrar Fila</button>
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n Niveles (colapsable) - Oculto en mobile -->
                <div id="levels-section-desktop" class="levels-section-desktop mt-4 border-t-2 border-gray-500 pt-4">
                    <button id="levels-section-toggle" type="button" class="w-full text-left flex items-center justify-between px-2 py-1 border-2 border-[#666] bg-gray-700">
                        <span>Niveles</span>
                        <span id="levels-section-arrow">‚ñº</span>
                    </button>
                    <div id="levels-section-content" class="mt-2">
                        <select id="level-selector" class="w-full bg-gray-700 border-2 border-[#666] p-1 text-sm mb-2"></select>
                        <button id="add-level-btn" class="nes-btn is-primary w-full text-xs">‚ûï Nuevo Nivel</button>
                        <button id="generate-level-btn" class="nes-btn is-success w-full text-xs">Generar Nivel</button>
                        <button id="save-all-btn" class="nes-btn is-error w-full mt-2 text-xs">Guardar en Archivo</button>
                        <button id="share-level-btn" class="nes-btn is-primary w-full mt-2 text-xs">üì§ Compartir Nivel</button>
                    </div>
                </div>
                
                <!-- Bot√≥n Volver al Men√∫ (oculto en mobile) -->
                <button id="back-to-menu-btn" class="back-to-menu-desktop nes-btn w-full mt-4 text-xs">Volver al Men√∫</button>
            </div>
        </div>

        <!-- Modal de Confirmaci√≥n -->
        <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex flex-col justify-center items-center text-center" style="z-index: 60;">
            <div class="nes-container with-title is-dark">
                <p class="title" id="modal-title">¬øEst√°s seguro?</p>
                <p id="modal-text" class="mb-8">Esto guardar√° el nivel actual y todos los cambios en el archivo JSON.</p>
                <div class="flex justify-center gap-4">
                    <button id="confirm-save-btn" class="nes-btn is-success">Confirmar</button>
                    <button id="cancel-save-btn" class="nes-btn">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- Modal de Confirmaci√≥n de Salida -->
        <div id="exit-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex flex-col justify-center items-center text-center" style="z-index: 60;">
            <div class="nes-container with-title is-dark max-w-lg">
                <p class="title" id="exit-title">Confirmar acci√≥n</p>
                <p id="exit-text" class="mb-8 text-lg whitespace-pre-line">¬øSeguro que deseas continuar?</p>
                <div class="flex justify-center gap-4">
                    <button id="exit-confirm-btn" class="nes-btn is-error">S√≠</button>
                    <button id="exit-cancel-btn" class="nes-btn">No</button>
                </div>
            </div>
        </div>

        <!-- Men√∫ flotante (pausa) -->
        <div id="pause-menu-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex flex-col justify-center items-center text-center" style="z-index: 100;">
            <div class="nes-container with-title is-dark max-w-sm w-80 max-h-[80vh] overflow-y-auto overflow-x-hidden">
                <p class="title">Men√∫</p>
                <div class="flex flex-col gap-3">
                    <button id="pause-resume-btn" class="nes-btn is-success">Continuar</button>
                    <button id="pause-restart-btn" class="nes-btn is-warning">Reiniciar</button>
                    <button id="pause-mainmenu-btn" class="nes-btn is-error">Men√∫ Inicial</button>
                    <button id="pause-settings-btn" class="nes-btn is-primary">Configuraci√≥n</button>
                    <button id="pause-credits-btn" class="nes-btn">Cr√©ditos</button>
                    <button id="pause-cancel-btn" class="nes-btn">Cerrar</button>
                </div>
            </div>
        </div>

        <!-- Modal de Notificaci√≥n -->
        <div id="notification-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex flex-col justify-center items-center text-center" style="z-index: 55;">
            <div class="nes-container with-title is-dark max-w-lg">
                <p class="title" id="notification-title">Notificaci√≥n</p>
                <p id="notification-message" class="mb-8 text-lg whitespace-pre-line"></p>
                <div class="flex justify-center">
                    <button id="notification-ok-btn" class="nes-btn is-primary">Aceptar</button>
                </div>
            </div>
        </div>

        <!-- Modal de Prompt (para reemplazar prompt()) -->
        <div id="prompt-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex flex-col justify-center items-center text-center" style="z-index: 60;">
            <div class="nes-container with-title is-dark max-w-lg">
                <p class="title" id="prompt-title">Entrada</p>
                <p id="prompt-message" class="mb-4 text-lg"></p>
                <input type="text" id="prompt-input" class="nes-input mb-4 w-full" placeholder="Escribe aqu√≠...">
                <div class="flex justify-center gap-4">
                    <button id="prompt-cancel-btn" class="nes-btn">Cancelar</button>
                    <button id="prompt-ok-btn" class="nes-btn is-primary">Aceptar</button>
                </div>
            </div>
        </div>

        <!-- Modal de Autenticaci√≥n: elegir Entrar o Crear cuenta -->
        <div id="auth-choice-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex flex-col justify-center items-center text-center" style="z-index: 10000;">
            <div class="nes-container with-title is-dark max-w-sm">
                <p class="title">Autenticaci√≥n</p>
                <p class="mb-6 text-sm">Para poder editar niveles, inicia sesi√≥n o crea una cuenta.</p>
                <div class="flex flex-col gap-3">
                    <button id="auth-login-btn" class="nes-btn is-success">Entrar</button>
                    <button id="auth-signup-btn" class="nes-btn is-primary">Crear cuenta</button>
                    <button id="auth-cancel-btn" class="nes-btn">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- Modal de Campa√±as -->
        <div id="campaigns-modal" class="hidden fixed inset-0 bg-black bg-opacity-90 flex flex-col justify-center items-center text-center" style="z-index: 50;">
            <div class="nes-container with-title is-dark max-w-2xl mx-6 max-h-[90vh] overflow-y-auto">
                <h1 id="campaigns-modal-title" class="title text-2xl md:text-3xl font-bold mb-4" style="font-family: 'Press Start 2P', monospace;">
                    Gestionar Campa√±as
                </h1>
                    
                    <!-- Lista de campa√±as -->
                    <div id="campaigns-list" class="mb-4">
                        <!-- Se llenar√° din√°micamente -->
                    </div>

                    <!-- Crear nueva campa√±a -->
                    <div class="mb-4 border-t-2 border-gray-600 pt-4">
                        <input type="text" id="new-campaign-name" class="nes-input w-full mb-2" placeholder="Nombre de la campa√±a">
                        <button id="create-campaign-btn" class="nes-btn is-primary w-full">Crear Campa√±a</button>
                    </div>
                </div>

                <div class="flex justify-center gap-4">
                    <button id="campaigns-modal-close-btn" class="nes-btn">Cerrar</button>
                </div>
            </div>
        </div>

        <!-- Modal: Agregar nivel a campa√±a -->
        <div id="add-to-campaign-modal" class="hidden fixed inset-0 bg-black bg-opacity-90 flex flex-col justify-center items-center text-center" style="z-index: 60;">
            <div class="nes-container with-title is-dark max-w-lg mx-6">
                <h1 id="add-to-campaign-title" class="title text-xl md:text-2xl font-bold mb-4" style="font-family: 'Press Start 2P', monospace;">
                    Agregar a Campa√±a
                </h1>
                <p id="add-to-campaign-message" class="mb-4">Selecciona una campa√±a para agregar este nivel:</p>
                
                <!-- Opci√≥n: Crear nueva campa√±a -->
                <div class="mb-4 p-3 border-2 border-gray-600 bg-gray-700">
                    <label class="block mb-2 text-sm font-bold" style="font-family: 'Press Start 2P', monospace;">Crear Nueva Campa√±a</label>
                    <input type="text" id="new-campaign-name-input" class="nes-input w-full mb-2" placeholder="Nombre de la nueva campa√±a">
                    <button id="create-campaign-and-add-btn" class="nes-btn is-success w-full">Crear y Agregar</button>
                </div>
                
                <div class="border-t-2 border-gray-600 pt-4 mb-4">
                    <label class="block mb-2 text-sm font-bold" style="font-family: 'Press Start 2P', monospace;">O Agregar a Campa√±a Existente</label>
                    <select id="add-to-campaign-selector" class="nes-select w-full mb-4 h-8"></select>
                </div>
                
                <div class="flex justify-center gap-4">
                    <button id="add-to-campaign-cancel-btn" class="nes-btn">Cancelar</button>
                    <button id="add-to-campaign-confirm-btn" class="nes-btn is-primary">Agregar</button>
                </div>
            </div>
        </div>

        <!-- Splash animado -->
        <div id="splash-container" style="z-index: 10;"></div>

        <!-- Selector de Idioma (arriba a la derecha) -->
        <div id="language-selector-container" class="fixed top-4 right-4 z-50" style="z-index: 1000;">
        <p style="font-family: 'Press Start 2P', monospace; padding: 0.5rem 1rem; font-size: 0.8rem;">LANGUAGE</p>
            <div class="flex gap-2">
                <button id="lang-es-btn" class="language-btn nes-btn is-primary active" data-lang="es" title="Espa√±ol" style="font-family: 'Press Start 2P', monospace; padding: 0.5rem 1rem; font-size: 1.2rem;">
                    ESP
                </button>
                <button id="lang-ca-btn" class="language-btn nes-btn" data-lang="ca" title="Catal√†" style="font-family: 'Press Start 2P', monospace; padding: 0.5rem 1rem; font-size: 1.2rem;">
                    CAT
                </button>
                <button id="lang-en-btn" class="language-btn nes-btn" data-lang="en" title="English" style="font-family: 'Press Start 2P', monospace; padding: 0.5rem 1rem; font-size: 1.2rem;">
                    ENG
                </button>
            </div>
        </div>

        <!-- Pantalla de Mensajes (Inicio) -->
        <div id="message-overlay" style="z-index: 10;">
            <p id="message-text" class="text-sm opacity-90"></p>
            
            <!-- Bot√≥n Principal: JUGAR -->
            <div class="mt-6 mb-4">
                <button id="start-game-btn" class="nes-btn is-success" style="font-family: 'Press Start 2P', monospace; min-width: 300px; font-size: 1.5rem; padding: 1rem 2rem;">
                JUGAR
                </button>
            </div>
            
            <!-- Botones Secundarios -->
            <div class="flex gap-3 flex-wrap justify-center">
                <button id="gallery-btn" class="nes-btn is-primary" style="font-family: 'Press Start 2P', monospace;">
                GALER√çA
                </button>
                <button id="level-editor-btn" class="nes-btn is-primary" style="font-family: 'Press Start 2P', monospace;">
                TOOLS
                </button>
                <button id="credits-btn" class="nes-btn" style="font-family: 'Press Start 2P', monospace;">
                CR√âDITOS
                </button>
            </div>
            
            <!-- Botones de Instalaci√≥n -->
            <div class="mt-4 flex gap-2 flex-wrap justify-center">
                <button id="install-pwa-btn" class="nes-btn is-success hidden text-xs" style="font-family: 'Press Start 2P', monospace;">
                    üì± INSTALAR APP
                </button>
                <button id="play-store-btn" class="nes-btn is-disabled text-xs opacity-50 cursor-not-allowed" style="font-family: 'Press Start 2P', monospace;">
                    üì≤ PLAY STORE (PR√ìXIMAMENTE)
                </button>
            </div>
            
            <!-- Bot√≥n Retry (hidden por defecto) -->
            <button id="retry-btn" class="nes-btn is-warning mt-4 hidden">Volver a jugar</button>
        </div>

        <!-- Modal Game Over -->
        <div id="gameover-modal" class="hidden fixed inset-0 bg-black bg-opacity-90 flex flex-col justify-center items-center text-center" style="z-index: 50;">
            <div class="nes-container with-title is-dark max-w-lg mx-6">
                <h1 id="gameover-title" class="title text-6xl md:text-7xl font-bold mb-6 text-red-600" style="text-shadow: 0 0 20px rgba(255, 0, 0, 0.8), 0 0 40px rgba(255, 0, 0, 0.4); font-family: 'Press Start 2P', monospace;">
                    GAME OVER
                </h1>
                <p id="gameover-score" class="text-xl mb-8 text-white font-bold" style="font-family: 'Press Start 2P', monospace;">
                    Puntuaci√≥n final: <span id="gameover-score-value" class="text-yellow-400">0</span>
                </p>
                <div class="flex flex-col gap-4">
                    <button id="gameover-retry-btn" class="nes-btn is-warning" style="font-family: 'Press Start 2P', monospace; min-width: 200px; font-size: 1rem; padding: 1rem;">
                        Volver a Intentar
                    </button>
                    <button id="gameover-menu-btn" class="nes-btn is-primary" style="font-family: 'Press Start 2P', monospace; min-width: 200px; font-size: 1rem; padding: 1rem;">
                        Men√∫ Principal
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal Level Complete (para editor) -->
        <div id="level-complete-modal" class="hidden fixed inset-0 bg-black bg-opacity-90 flex flex-col justify-center items-center text-center" style="z-index: 50;">
            <div class="nes-container with-title is-dark max-w-lg mx-6">
                <h1 id="level-complete-title" class="title text-4xl md:text-5xl font-bold mb-6 text-green-400" style="text-shadow: 0 0 20px rgba(0, 255, 0, 0.8), 0 0 40px rgba(0, 255, 0, 0.4); font-family: 'Press Start 2P', monospace;">
                    LEVEL COMPLETE
                </h1>
                <div class="flex flex-col gap-4">
                    <button id="level-complete-back-to-editor-btn" class="nes-btn is-primary" style="font-family: 'Press Start 2P', monospace; min-width: 200px; font-size: 1rem; padding: 1rem;">
                        Volver al Editor
                    </button>
                    <button id="level-complete-restart-btn" class="nes-btn is-warning" style="font-family: 'Press Start 2P', monospace; min-width: 200px; font-size: 1rem; padding: 1rem;">
                        Reiniciar
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal Cr√©ditos -->
        <div id="credits-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex flex-col justify-center items-center text-center" style="z-index: 50;">
            <!-- Canvas para part√≠culas animadas -->
            <canvas id="credits-particles" class="absolute inset-0 w-full h-full" style="z-index: 0;"></canvas>
            
            <!-- Contenido del modal -->
            <div class="nes-container with-title is-dark max-w-lg mx-6 relative" style="z-index: 10;">
                <p class="title credits-title" style="font-family: 'Press Start 2P', monospace;">Cr√©ditos</p>
                <p class="mb-6 text-sm leading-relaxed credits-text" style="font-family: 'Press Start 2P', monospace;">
                    developed by: <strong class="credits-name">argentinardo</strong>
                    <br>
                    <a href="https://www.damiannardini.com" target="_blank" rel="noopener" class="credits-link underline text-yellow-400 hover:text-yellow-300">damiannardini.com</a>
                    <br><br>
                    <span class="credits-special">con la gran ayuda de mi hijo ‚ù§Ô∏èPaolo‚ù§Ô∏è</span>
                </p>
                <button id="credits-close-btn" class="nes-btn is-primary credits-btn" style="font-family: 'Press Start 2P', monospace;">Cerrar</button>
            </div>
        </div>

        <!-- Modal de Configuraci√≥n -->
        <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex flex-col justify-center items-center text-center" style="z-index: 50;">
            <div class="nes-container with-title is-dark max-w-lg mx-6 max-h-[90vh] overflow-y-auto overflow-x-hidden">
                <p id="settings-modal-title" class="title">Configuraci√≥n</p>
                
                <!-- Secci√≥n Audio -->
                <div class="mb-6 text-left">
                    <h3 id="settings-sound-title" class="text-xl mb-4 border-b-2 border-gray-600 pb-2">Sonido</h3>
                    
                    <!-- Volumen M√∫sica -->
                    <div class="mb-4">
                        <label id="settings-music-volume-label" for="music-volume-slider" class="block mb-2 text-sm">Volumen M√∫sica:</label>
                        <div class="flex items-center gap-3">
                            <input type="range" id="music-volume-slider" min="0" max="100" value="30" 
                                   class="flex-1 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-yellow-400">
                            <span id="music-volume-value" class="text-sm font-bold min-w-[40px]">30%</span>
                        </div>
                    </div>
                    
                    <!-- Volumen Efectos -->
                    <div class="mb-4">
                        <label id="settings-sfx-volume-label" for="sfx-volume-slider" class="block mb-2 text-sm">Volumen Efectos:</label>
                        <div class="flex items-center gap-3">
                            <input type="range" id="sfx-volume-slider" min="0" max="100" value="50" 
                                   class="flex-1 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-yellow-400">
                            <span id="sfx-volume-value" class="text-sm font-bold min-w-[40px]">50%</span>
                        </div>
                    </div>
                    
                    <!-- Toggle Mute -->
                    <div class="mb-3 flex items-center justify-between">
                        <label id="settings-sound-status-label" for="mute-toggle" class="text-sm cursor-pointer flex-1">Sonido:</label>
                        <input type="checkbox" id="mute-toggle" 
                               class="w-5 h-5 cursor-pointer accent-yellow-400">
                        <span id="mute-status" class="text-sm font-bold ml-2 min-w-[60px] text-left">ON</span>
                    </div>
                </div>
                
                <!-- Secci√≥n Gr√°ficos -->
                <div class="mb-6 text-left">
                    <h3 id="settings-graphics-title" class="text-xl mb-4 border-b-2 border-gray-600 pb-2">Gr√°ficos</h3>
                    <p id="settings-graphics-desc" class="text-xs text-gray-400 mb-4">Desactiva efectos para mejorar el rendimiento en dispositivos m√≥viles antiguos</p>
                    
                    <!-- Scanline -->
                    <div class="mb-3 flex items-center justify-between">
                        <label for="scanline-toggle" class="text-sm cursor-pointer flex-1">Scanline (efecto CRT):</label>
                        <input type="checkbox" id="scanline-toggle" checked 
                               class="w-5 h-5 cursor-pointer accent-yellow-400">
                    </div>
                    
                    <!-- Glow -->
                    <div class="mb-3 flex items-center justify-between">
                        <label for="glow-toggle" class="text-sm cursor-pointer flex-1">Efectos de Glow (brillo):</label>
                        <input type="checkbox" id="glow-toggle" checked 
                               class="w-5 h-5 cursor-pointer accent-yellow-400">
                    </div>
                    
                    <!-- Brightness -->
                    <div class="mb-3 flex items-center justify-between">
                        <label for="brightness-toggle" class="text-sm cursor-pointer flex-1">Brillo del Canvas:</label>
                        <input type="checkbox" id="brightness-toggle" checked 
                               class="w-5 h-5 cursor-pointer accent-yellow-400">
                    </div>
                    
                    <!-- Contrast -->
                    <div class="mb-3 flex items-center justify-between">
                        <label for="contrast-toggle" class="text-sm cursor-pointer flex-1">Contraste del Canvas:</label>
                        <input type="checkbox" id="contrast-toggle" checked 
                               class="w-5 h-5 cursor-pointer accent-yellow-400">
                    </div>
                    
                    <!-- Vignette -->
                    <div class="mb-3 flex items-center justify-between">
                        <label for="vignette-toggle" class="text-sm cursor-pointer flex-1">Vignette (oscurecimiento bordes):</label>
                        <input type="checkbox" id="vignette-toggle" checked 
                               class="w-5 h-5 cursor-pointer accent-yellow-400">
                    </div>
                    
                    <!-- Blur -->
                    <div class="mb-3 flex items-center justify-between">
                        <label for="blur-toggle" class="text-sm cursor-pointer flex-1">Blur (desenfoque):</label>
                        <input type="checkbox" id="blur-toggle" checked 
                               class="w-5 h-5 cursor-pointer accent-yellow-400">
                    </div>
                    
                    <!-- Show FPS -->
                    <div class="mb-3 flex items-center justify-between">
                        <label for="fps-toggle" class="text-sm cursor-pointer flex-1">Mostrar Contador FPS:</label>
                        <input type="checkbox" id="fps-toggle" 
                               class="w-5 h-5 cursor-pointer accent-yellow-400">
                    </div>
                    
                    <!-- Mobile Full Width (solo visible en mobile) -->
                    <div id="mobile-fullwidth-option" class="mb-3 flex items-center justify-between hidden">
                        <label for="mobile-fullwidth-toggle" class="text-sm cursor-pointer flex-1">Ancho Completo (Mobile):</label>
                        <input type="checkbox" id="mobile-fullwidth-toggle" 
                               class="w-5 h-5 cursor-pointer accent-yellow-400">
                    </div>
                </div>
                
                <!-- Secci√≥n Controles (solo en m√≥vil) -->
                <div id="mobile-controls-settings" class="mb-6 text-left" style="display: none;">
                    <h3 class="text-xl mb-4 border-b-2 border-gray-600 pb-2" id="settings-controls-title">Controles</h3>
                    <div class="mb-3">
                        <label for="control-mode-selector" class="block mb-2 text-sm" id="settings-control-mode-label">Modo de Control:</label>
                        <select id="control-mode-selector" class="w-full bg-gray-700 border-2 border-[#666] p-2 text-sm">
                            <option value="hybrid" id="control-mode-hybrid">H√≠brido</option>
                            <option value="onehand" id="control-mode-onehand">Una Mano</option>
                            <option value="virtual" id="control-mode-virtual">Virtual</option>
                        </select>
                    </div>
                </div>
                
                <!-- Secci√≥n Idioma -->
                <div class="mb-6 text-left">
                    <h3 class="text-xl mb-4 border-b-2 border-gray-600 pb-2" id="settings-language-title">Idioma</h3>
                    <div class="mb-3">
                        <label for="language-selector" class="block mb-2 text-sm" id="settings-language-label">Idioma:</label>
                        <select id="language-selector" class="w-full bg-gray-700 border-2 border-[#666] p-2 text-sm">
                            <option value="es">Espa√±ol</option>
                            <option value="en">English</option>
                            <option value="ca">Catal√†</option>
                        </select>
                    </div>
                </div>
                
                <!-- Botones -->
                <div class="flex justify-center gap-4">
                    <button id="settings-close-btn" class="nes-btn is-primary">Cerrar</button>
                </div>
            </div>
        </div>

        <!-- Controles M√≥viles -->
        <div id="mobile-controls" class="hidden">
            <div id="directional-buttons">
                <div class="button-row">
                    <button id="btn-up-left" class="directional-btn">‚Üñ</button>
                    <button id="btn-up" class="directional-btn">‚Üë</button>
                    <button id="btn-up-right" class="directional-btn">‚Üó</button>
                </div>
                <div class="button-row">
                    <button id="btn-left" class="directional-btn">‚Üê</button>
                    <button id="btn-right" class="directional-btn">‚Üí</button>
                </div>
            </div>
            <div id="joystick-zone">

            </div>
            <div id="action-zone">
                <button id="shoot-btn" class="action-button">FIRE</button>
                <button id="bomb-btn" class="action-button">TNT</button>
            </div>
        </div>

        <!-- Modal Galer√≠a de Niveles -->
        <div id="gallery-modal" class="hidden fixed inset-0 bg-black bg-opacity-90 flex flex-col justify-center items-center overflow-y-auto" style="z-index: 50;">
            <div class="nes-container with-title is-dark max-w-6xl mx-6 my-8" style="box-shadow: 0 0 30px rgba(147, 51, 234, 0.5); max-height: 90vh; overflow-y: auto; overflow-x: hidden;">
                <div class="flex justify-between items-center mb-6">
                    <p class="title text-3xl font-bold text-purple-400" style="font-family: 'Press Start 2P', monospace;">GALER√çA DE NIVELES</p>
                    <button id="gallery-close-btn" class="nes-btn">‚úï</button>
                </div>
                
                <!-- Filtros y ordenamiento -->
                <div class="mb-6 flex gap-4 items-center flex-wrap">
                    <label class="text-sm">Ordenar por:</label>
                    <button id="gallery-sort-likes" class="nes-btn is-primary">M√°s Votados</button>
                    <button id="gallery-sort-newest" class="nes-btn">M√°s Nuevos</button>
                    <button id="gallery-sort-downloads" class="nes-btn">M√°s Descargados</button>
                </div>
                
                <!-- Grid de niveles -->
                <div id="gallery-levels-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Los niveles se cargar√°n aqu√≠ din√°micamente -->
                    <div class="col-span-full text-center text-gray-500 p-8">
                        <p>Cargando niveles...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Mi √Årea de user -->
        <div id="profile-modal" class="hidden fixed inset-0 bg-black bg-opacity-90 flex flex-col justify-center items-center" style="z-index: 50;">
            <div class="nes-container with-title is-dark max-w-2xl mx-6" style="box-shadow: 0 0 30px rgba(37, 99, 235, 0.5);">
                <div class="flex justify-between items-center mb-6">
                    <p class="title text-2xl font-bold text-blue-400" style="font-family: 'Press Start 2P', monospace;">MI √ÅREA</p>
                    <button id="profile-close-btn" class="nes-btn">‚úï</button>
                </div>
                
                <div class="space-y-4">
                    <!-- Avatar -->
                    <div class="mb-4">
                        <label class="block text-sm mb-2">Avatar:</label>
                        <div class="flex items-center gap-4">
                            <canvas id="profile-avatar-preview" width="80" height="80" class="w-20 h-20 bg-gray-700 border-2 border-white rounded avatar-canvas"></canvas>
                            <button id="profile-avatar-btn" class="nes-btn is-primary text-xs">Cambiar Avatar</button>
                        </div>
                    </div>
                    
                    <!-- Nickname -->
                    <div class="mb-4">
                        <label class="block text-sm mb-2">Nickname:</label>
                        <input type="text" id="profile-nickname-input" class="w-full bg-gray-800 border-2 border-white p-2 text-white" placeholder="Tu nickname">
                    </div>
                    
                    <!-- Email (solo lectura) -->
                    <div class="mb-4">
                        <label class="block text-sm mb-2">Email:</label>
                        <input type="text" id="profile-email-display" class="w-full bg-gray-700 border-2 border-gray-600 p-2 text-gray-400" readonly>
                    </div>
                    
                    <!-- Botones -->
                    <div class="flex gap-4 justify-end">
                        <button id="profile-cancel-btn" class="nes-btn">Cancelar</button>
                        <button id="profile-save-btn" class="nes-btn is-success">Guardar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
