<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autenticaci√≥n - NEW H.E.R.O.</title>
    <style>
        body {
            font-family: 'Press Start 2P', monospace;
            background: #1f2937;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            text-align: center;
        }
        .container {
            padding: 2rem;
        }
        .message {
            font-size: 0.8rem;
            margin-bottom: 1rem;
        }
        .spinner {
            border: 4px solid #3b82f6;
            border-top: 4px solid transparent;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="message">Procesando autenticaci√≥n...</div>
        <div class="spinner"></div>
    </div>
    <script>
        (function() {
            console.log('[Auth0 Callback] P√°gina de callback cargada');
            console.log('[Auth0 Callback] URL actual:', window.location.href);
            console.log('[Auth0 Callback] Protocol:', window.location.protocol);
            console.log('[Auth0 Callback] Hostname:', window.location.hostname);
            
            // CR√çTICO: Solo usar deep links si realmente estamos en Capacitor (app nativa)
            // NO usar deep links en navegador web, incluso si es Android
            const isCapacitor = typeof window.Capacitor !== 'undefined';
            // Verificar tambi√©n si Capacitor est√° realmente disponible y funcionando
            let isNativePlatform = false;
            if (isCapacitor && window.Capacitor && typeof window.Capacitor.isNativePlatform === 'function') {
                isNativePlatform = window.Capacitor.isNativePlatform();
            } else {
                isNativePlatform = isCapacitor;
            }
            
            // Solo considerar app m√≥vil si realmente est√° en Capacitor
            // NO usar detecci√≥n por User Agent porque puede ser navegador web en Android
            const isMobileApp = isNativePlatform;
            
            console.log('[Auth0 Callback] isCapacitor:', isCapacitor);
            console.log('[Auth0 Callback] isNativePlatform:', isNativePlatform);
            console.log('[Auth0 Callback] isMobileApp:', isMobileApp);
            console.log('[Auth0 Callback] User Agent:', navigator.userAgent);
            
            // Obtener los par√°metros de la URL
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');
            const errorDescription = urlParams.get('error_description');
            
            console.log('[Auth0 Callback] code:', code ? 'presente' : 'ausente');
            console.log('[Auth0 Callback] error:', error || 'ninguno');
            console.log('[Auth0 Callback] errorDescription:', errorDescription || 'ninguno');
            
            // Si hay un error, mostrarlo
            if (error) {
                console.error('[Auth0 Callback] Error recibido:', error);
                document.querySelector('.message').textContent = 'Error: ' + (errorDescription || error);
                setTimeout(() => {
                    if (isMobileApp) {
                        console.log('[Auth0 Callback] üì± Redirigiendo a app con error');
                        const errorDeepLink = 'com.newhero.game://callback?error=' + encodeURIComponent(error);
                        const packageName = 'com.newhero.game';
                        const errorIntentUrl = 'intent://callback?error=' + encodeURIComponent(error) +
                            '#Intent;scheme=com.newhero.game;package=' + packageName + ';end';
                        try {
                            window.location.href = errorIntentUrl;
                        } catch (e) {
                            try {
                                window.location.replace(errorDeepLink);
                            } catch (e2) {
                                window.location.href = errorDeepLink;
                            }
                        }
                    } else {
                        console.log('[Auth0 Callback] üåê Redirigiendo a p√°gina de inicio');
                        window.location.href = '/';
                    }
                }, 3000);
                return;
            }
            
            // Si hay un code (de Auth0), procesar
            if (code && state) {
                console.log('[Auth0 Callback] ‚úÖ Auth0 authorization code recibido');
                
                if (isMobileApp) {
                    console.log('[Auth0 Callback] üì± DETECTADA APP M√ìVIL - REDIRIGIENDO VIA DEEP LINK');
                    // Redirigir a la app con el code
                    const deepLinkUrl = 'com.newhero.game://callback?' + 
                        'code=' + encodeURIComponent(code) +
                        '&state=' + encodeURIComponent(state);
                    
                    // CR√çTICO: Usar Android Intent URL para que el navegador pueda abrir la app
                    // Formato: intent://[host]/[path]#Intent;scheme=[scheme];package=[package];end
                    // Para par√°metros de query, usamos el deep link completo en el scheme
                    const packageName = 'com.newhero.game';
                    // Construir el Intent URL con el deep link codificado
                    const intentUrl = 'intent://callback?code=' + encodeURIComponent(code) +
                        '&state=' + encodeURIComponent(state) +
                        '#Intent;scheme=com.newhero.game;package=' + packageName + ';end';
                    
                    console.log('[Auth0 Callback] üéØ Deep link URL:', deepLinkUrl);
                    console.log('[Auth0 Callback] üéØ Intent URL:', intentUrl);
                    console.log('[Auth0 Callback] Redirigiendo en 1 segundo...');
                    
                    setTimeout(() => {
                        console.log('[Auth0 Callback] üöÄ REDIRIGIENDO AHORA');
                        try {
                            // Intentar usar Android Intent URL primero (funciona desde navegador)
                            window.location.href = intentUrl;
                        } catch (e) {
                            console.warn('[Auth0 Callback] Intent URL fall√≥, intentando deep link directo:', e);
                            try {
                                // Fallback: intentar deep link directo
                                window.location.replace(deepLinkUrl);
                            } catch (e2) {
                                console.warn('[Auth0 Callback] location.replace fall√≥, intentando con href:', e2);
                                try {
                                    window.location.href = deepLinkUrl;
                                } catch (e3) {
                                    console.error('[Auth0 Callback] ‚ùå Error al redirigir:', e3);
                                    // √öltimo recurso: intentar abrir en nueva ventana
                                    window.open(deepLinkUrl, '_self');
                                }
                            }
                        }
                    }, 1000);
                } else {
                    console.log('[Auth0 Callback] üåê DETECTADA WEB - Redirigiendo a p√°gina principal para que SDK procese');
                    // En web, necesitamos redirigir a la p√°gina principal donde est√° el SDK
                    // El SDK detectar√° autom√°ticamente los par√°metros code y state en la URL
                    // y procesar√° el callback
                    // CR√çTICO: window.location.search ya incluye el '?', as√≠ que solo concatenamos
                    const mainUrl = window.location.origin + window.location.pathname.replace('/auth0-callback.html', '/') + (window.location.search || '');
                    console.log('[Auth0 Callback] Redirigiendo a:', mainUrl);
                    window.location.href = mainUrl;
                }
            } else {
                // No hay code ni error
                console.log('[Auth0 Callback] ‚ö†Ô∏è No se recibi√≥ code de Auth0');
                document.querySelector('.message').textContent = 'Por favor espera...';
                
                // Esperar un poco y redirigir
                setTimeout(() => {
                    if (isMobileApp) {
                        console.log('[Auth0 Callback] üì± Redirigiendo a app');
                        const noCodeDeepLink = 'com.newhero.game://callback?error=no_code';
                        const packageName = 'com.newhero.game';
                        const noCodeIntentUrl = 'intent://callback?error=no_code' +
                            '#Intent;scheme=com.newhero.game;package=' + packageName + ';end';
                        try {
                            window.location.href = noCodeIntentUrl;
                        } catch (e) {
                            try {
                                window.location.replace(noCodeDeepLink);
                            } catch (e2) {
                                window.location.href = noCodeDeepLink;
                            }
                        }
                    } else {
                        console.log('[Auth0 Callback] üåê Redirigiendo a p√°gina de inicio');
                        window.location.href = '/';
                    }
                }, 2000);
            }
        })();
    </script>
</body>
</html>

