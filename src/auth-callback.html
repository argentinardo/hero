<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autenticaci√≥n - NEW H.E.R.O.</title>
    <style>
        body {
            font-family: 'Press Start 2P', monospace;
            background: #1f2937;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            text-align: center;
        }
        .container {
            padding: 2rem;
        }
        .message {
            font-size: 0.8rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="message">Procesando autenticaci√≥n...</div>
    </div>
    <script>
        (function() {
            console.log('[Auth Callback] P√°gina de callback cargada');
            console.log('[Auth Callback] URL actual:', window.location.href);
            console.log('[Auth Callback] Protocol:', window.location.protocol);
            console.log('[Auth Callback] Hostname:', window.location.hostname);
            console.log('[Auth Callback] User Agent:', navigator.userAgent);
            
            // Detectar si viene de la app m√≥vil (Capacitor)
            // CLAVE: Usamos m√∫ltiples se√±ales para detectar APK
            const isCapacitor = typeof window.Capacitor !== 'undefined';
            const isAndroid = /Android/i.test(navigator.userAgent);
            // En Capacitor, la app se ejecuta desde https://localhost en la APK
            const isLocalhostApp = window.location.hostname === 'localhost' && /Android/i.test(navigator.userAgent);
            const isMobileApp = isCapacitor || isAndroid || isLocalhostApp;
            
            console.log('[Auth Callback] isCapacitor:', isCapacitor, '| isAndroid:', isAndroid, '| isLocalhostApp:', isLocalhostApp, '| isMobileApp:', isMobileApp);
            
            // Obtener los par√°metros de la URL
            const urlParams = new URLSearchParams(window.location.search);
            const accessToken = urlParams.get('access_token');
            const tokenType = urlParams.get('token_type') || 'Bearer';
            const expiresIn = urlParams.get('expires_in');
            const error = urlParams.get('error');
            const errorDescription = urlParams.get('error_description');
            
            console.log('[Auth Callback] accessToken:', accessToken ? 'presente' : 'ausente');
            console.log('[Auth Callback] error:', error || 'ninguno');
            console.log('[Auth Callback] errorDescription:', errorDescription || 'ninguno');
            
            // Si hay un error, mostrarlo
            if (error) {
                console.error('[Auth Callback] Error recibido:', error);
                document.querySelector('.message').textContent = 'Error: ' + (errorDescription || error);
                setTimeout(() => {
                    if (isMobileApp) {
                        console.log('[Auth Callback] Intentando redirigir a app con error');
                        // Intentar cerrar el WebView y volver a la app
                        window.location.href = 'com.newhero.game://auth-callback?error=' + encodeURIComponent(error);
                    } else {
                        console.log('[Auth Callback] Cerrando ventana (no es app m√≥vil)');
                        window.close();
                    }
                }, 3000);
                return;
            }
            
            // Si hay un token, procesarlo
            if (accessToken) {
                console.log('[Auth Callback] ‚úÖ Token de acceso recibido');
                console.log('[Auth Callback] Token preview:', accessToken.substring(0, 20) + '...');
                
                if (isMobileApp) {
                    console.log('[Auth Callback] üì± DETECTADA APP M√ìVIL - REDIRIGIENDO VIA DEEP LINK');
                    // Construir la URL de callback con el token
                    const callbackUrl = 'com.newhero.game://auth-callback?' + 
                        'access_token=' + encodeURIComponent(accessToken) +
                        '&token_type=' + encodeURIComponent(tokenType) +
                        (expiresIn ? '&expires_in=' + encodeURIComponent(expiresIn) : '');
                    
                    console.log('[Auth Callback] üéØ URL de redirect:', callbackUrl);
                    console.log('[Auth Callback] Redirigiendo en 1 segundo...');
                    
                    // Peque√±a espera para asegurar que el log se procese
                    setTimeout(() => {
                        console.log('[Auth Callback] üöÄ REDIRIGIENDO AHORA');
                        window.location.href = callbackUrl;
                    }, 1000);
                } else {
                    console.log('[Auth Callback] üåê DETECTADA WEB - PROCESANDO NORMALMENTE');
                    // Si es web, cerrar la ventana y notificar al padre
                    if (window.opener) {
                        console.log('[Auth Callback] Enviando token al padre via postMessage');
                        // Enviar el token al padre
                        window.opener.postMessage({
                            type: 'netlify-auth-callback',
                            access_token: accessToken,
                            token_type: tokenType,
                            expires_in: expiresIn
                        }, window.location.origin);
                        window.close();
                    } else {
                        console.log('[Auth Callback] No hay opener, guardando en localStorage y redirigiendo a /');
                        // Si no hay opener, intentar guardar en localStorage y redirigir
                        localStorage.setItem('netlify-auth-token', accessToken);
                        localStorage.setItem('netlify-auth-token-type', tokenType);
                        if (expiresIn) {
                            localStorage.setItem('netlify-auth-expires-in', expiresIn);
                        }
                        window.location.href = '/';
                    }
                }
            } else {
                // No hay token, mostrar error
                console.error('[Auth Callback] ‚ùå No se recibi√≥ token de autenticaci√≥n');
                document.querySelector('.message').textContent = 'Error: No se recibi√≥ el token de autenticaci√≥n';
                setTimeout(() => {
                    if (isMobileApp) {
                        console.log('[Auth Callback] üì± Redirigiendo app con error: no_token');
                        window.location.href = 'com.newhero.game://auth-callback?error=no_token';
                    } else {
                        console.log('[Auth Callback] üåê Cerrando ventana (web)');
                        window.close();
                    }
                }, 3000);
            }
        })();
    </script>
</body>
</html>

